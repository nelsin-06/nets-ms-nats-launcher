<!DOCTYPE html>
<html>
<head>
    <title>Store MS Architecture</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
    <h1>Store MS - Interactive Architecture</h1>
    
    <div class="mermaid">
        flowchart TD
    %% Development Phase
    Dev["ğŸ‘¨â€ğŸ’» Desarrollo Local"] --> Git["ğŸ”„ Git Push a main"]
    
    %% GitHub Repositories Structure
    subgraph GITHUB_ORG["ğŸ¢ nest-microservices-nel"]
        GH1["ğŸ“ client-gateway<br/>ğŸŒ API Gateway"]
        GH2["ğŸ“ auth-ms<br/>ğŸ” Authentication"]
        GH3["ğŸ“ payments-s<br/>ğŸ’³ Payments"]
        GH4["ğŸ“ order-ms<br/>ğŸ›’ Orders"]
        GH5["ğŸ“ products-ms<br/>ğŸ“¦ Products"]
    end
    
    subgraph MAIN_REPO["ğŸ  Main Repository"]
        GH_MAIN["ğŸ“ nets-ms-nats-launcher<br/>ğŸ¯ Orchestration<br/>Git Submodules"]
    end
    
    %% Cloud Build Triggers
    subgraph TRIGGERS["âš¡ Cloud Build Triggers"]
        CB1["ğŸ”¨ client-gateway-trigger"]
        CB2["ğŸ”¨ auth-ms-trigger"]
        CB3["ğŸ”¨ payments-s-trigger"]
        CB4["ğŸ”¨ order-ms-trigger"]
        CB5["ğŸ”¨ products-ms-trigger"]
    end
    
    %% Docker Build Process
    subgraph DOCKER_BUILD["ğŸ³ Docker Build"]
        D1["ğŸ—ï¸ client-gateway-prod<br/>dockerfile.prod"]
        D2["ğŸ—ï¸ auth-ms-prod<br/>dockerfile.prod"]
        D3["ğŸ—ï¸ payments-s-prod<br/>dockerfile.prod"]
        D4["ğŸ—ï¸ order-ms-prod<br/>dockerfile.prod"]
        D5["ğŸ—ï¸ products-ms-prod<br/>dockerfile.prod"]
    end
    
    %% Artifact Registry
    AR["ğŸª Artifact Registry<br/>microservices-nats-nest<br/>images-register-docker"]
    
    %% Kubernetes Deployment
    subgraph K8S_DEPLOY["â˜¸ï¸ Kubernetes GKE"]
        HELM["âš™ï¸ Helm Chart<br/>store-ms"]
        
        subgraph SECRETS["ğŸ” Secrets"]
            SECRET1["ğŸ”‘ auth-ms-secrets"]
            SECRET2["ğŸ”‘ orders-ms-secrets"]
            SECRET3["ğŸ”‘ payments-ms-secrets"]
            SECRET4["ğŸ”‘ gcr-json-key"]
        end
    end
    
    %% Kubernetes Resources
    subgraph PODS["ğŸš€ Kubernetes Pods"]
        POD1["ğŸ”· client-gateway<br/>Port: 3000<br/>512Mi-1Gi CPU: 250m-500m"]
        POD2["ğŸ”· auth-ms<br/>MongoDB + JWT"]
        POD3["ğŸ”· payments-s<br/>Stripe Integration"]
        POD4["ğŸ”· order-ms<br/>PostgreSQL"]
        POD5["ğŸ”· products-ms<br/>SQLite Database"]
        POD6["ğŸ”· NATS Server<br/>Port: 4222"]
    end
    
    %% NATS Communication
    subgraph NATS_COMM["ğŸ“¨ NATS Communication"]
        NATS_SYNC["ğŸ”„ Request-Reply<br/>auth.validate<br/>products.findAll"]
        NATS_ASYNC["âš¡ Events<br/>order.created<br/>payment.completed"]
    end
    
    %% Services
    subgraph SERVICES["ğŸ”§ Services"]
        SVC1["ğŸŒ client-gateway"]
        SVC2["ğŸ” auth-ms"]
        SVC3["ğŸ’³ payments-s"]
        SVC4["ğŸ›’ order-ms"]
        SVC5["ğŸ“¦ products-ms"]
        SVC6["ğŸ“¨ nats-server"]
    end
    
    %% Ingress Configuration
    subgraph INGRESS_CONFIG["ğŸŒ External Access"]
        SSL["ğŸ”’ SSL Certificate<br/>api-ssl-cert-gateway"]
        ING["ğŸšª Ingress Controller"]
        EXT1["ğŸŒ Gateway API<br/>store.ms.34.8.73.132.nip.io"]
        EXT2["ğŸ”— Payments Webhook"]
    end
    
    %% External Services
    subgraph EXTERNAL["ğŸŒ External Services"]
        STRIPE["ğŸ’³ Stripe API"]
        DATABASES["ğŸ—„ï¸ Databases<br/>MongoDB, PostgreSQL"]
    end
    
    %% Monitoring
    subgraph MONITORING["ğŸ“Š Monitoring"]
        HEALTH["â¤ï¸ Health Checks"]
        POSTMAN["ğŸ“® Postman Collection"]
    end
    
    %% Flow Connections
    Dev --> Git
    Git --> GH_MAIN
    Git --> GH1
    Git --> GH2
    Git --> GH3
    Git --> GH4
    Git --> GH5
    
    GH1 --> CB1
    GH2 --> CB2
    GH3 --> CB3
    GH4 --> CB4
    GH5 --> CB5
    
    CB1 --> D1
    CB2 --> D2
    CB3 --> D3
    CB4 --> D4
    CB5 --> D5
    
    D1 --> AR
    D2 --> AR
    D3 --> AR
    D4 --> AR
    D5 --> AR
    
    AR --> HELM
    HELM --> SECRET1
    HELM --> SECRET2
    HELM --> SECRET3
    HELM --> SECRET4
    
    HELM --> POD1
    SECRET1 --> POD2
    SECRET2 --> POD4
    SECRET3 --> POD3
    SECRET4 --> POD5
    HELM --> POD6
    
    POD6 --> NATS_SYNC
    POD6 --> NATS_ASYNC
    NATS_SYNC --> POD1
    NATS_ASYNC --> POD1
    
    POD1 --> SVC1
    POD2 --> SVC2
    POD3 --> SVC3
    POD4 --> SVC4
    POD5 --> SVC5
    POD6 --> SVC6
    
    SVC1 --> ING
    SVC3 --> ING
    SSL --> ING
    ING --> EXT1
    ING --> EXT2
    
    EXT2 --> STRIPE
    POD2 --> DATABASES
    POD4 --> DATABASES
    
    POD1 --> HEALTH
    EXT1 --> POSTMAN
    
    %% Styling
    classDef gitRepo fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef mainRepo fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px
    classDef cloudBuild fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef docker fill:#e1f5fe,stroke:#0288d1,stroke-width:2px
    classDef registry fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef k8s fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef pods fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef nats fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef services fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    classDef ingress fill:#fff8e1,stroke:#f9a825,stroke-width:2px
    classDef external fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef monitoring fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    
    class GH1,GH2,GH3,GH4,GH5 gitRepo
    class GH_MAIN mainRepo
    class CB1,CB2,CB3,CB4,CB5 cloudBuild
    class D1,D2,D3,D4,D5 docker
    class AR registry
    class HELM,SECRET1,SECRET2,SECRET3,SECRET4 k8s
    class POD1,POD2,POD3,POD4,POD5,POD6 pods
    class NATS_SYNC,NATS_ASYNC nats
    class SVC1,SVC2,SVC3,SVC4,SVC5,SVC6 services
    class SSL,ING,EXT1,EXT2 ingress
    class STRIPE,DATABASES external
    class HEALTH,POSTMAN monitoring
    </div>
    
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#fff',
                primaryTextColor: '#000'
            }
        });
    </script>
</body>
</html>
